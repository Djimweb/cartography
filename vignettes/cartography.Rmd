---
title: 'The cartography Package'
author: "Timothée Giraud, Nicolas Lambert"
date: '`r Sys.Date()`'
output: 
 rmarkdown::html_vignette: 
    toc: true
vignette: >
  %\VignetteIndexEntry{The cartography Package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r echo=FALSE}
knitr::opts_chunk$set(collapse = TRUE)

knitr::knit_hooks$set(margin = function(before, options, envir){
  if (before){
    par(mar=c(0.1,0.1,1.3,0.1))
  } 
})
```

# Design

The aim of `cartography` is to obtain thematic maps with the visual quality of those build with other common mapping and GIS software.  

Users of the package could belong to one of two categories: cartographers willing to use R or R users willing to create maps. Therefore, its functions have to be intuitive to cartographers and ensure compatibility with common R workflows.  

`cartography` uses `sf` or `sp` objects to produces `base` graphics. As most of the internals of the package relies on `sf` functionnalities, the prefered format for spatial objects is `sf`.  

`cartography`'s functions can be classified in the following categories :

- Symbology  
- Legends  
- Transformations 
- Map Layout   
- Color Palettes 


## Symbology 
*`*Layer()` functions*   
Each function focuses on a single cartographic representation (e.g. proportional symbols or choropleth representation) and displays it on a georeferenced plot. This solution allows to consider each representation as a layer and to overlay multiple representations on a same map.  

Each function has two main arguments that are:

- `x`, a spatial object (preferably an `sf` object),  
- `var`, the name of a variable to map.  

`sp` objects are handled through the `spdf` argument if the variable is contained within the `Spatial*DataFrame` and through `spdf`, `spdfid`, `df`, `dfid` if the variable is in a separate `data.frame` that needs to be joined to the `Spatial*DataFrame`. 

Many parameters are available to fine tune the cartographic representation. These parameters are the common ones found in GIS and automatic cartography software (e.g. classification and color palettes used in choropleth maps, symbols sizes used in proportional symbols maps...).

## Legends
*`legend*()` functions*   
Legends are displayed by default along cartographic layerd but more parameters are available through `legend*()` functions.

## Transformations 
*`get*()` functions*  
A set of functions is dedicated to the creation or transformation of spatial objects (e.g. borders extraction, grid or links creation). These functions are provided to ease the creation of some more advanced maps that usually need geo-processing. 

## Map Layout
Along with the cartographic functions, some other functions are dedicated to layout design (e.g. customizable scale bar, north arrow, title, sources or author information...).

## Color Palettes 
16 original color palettes are shipped within the package. Those palettes can be sustomized and combined. 



# Examples of thematic maps

<!-- # How to Import a Geospatial Vector Data File -->

<!-- ## The `rgdal` Way -->
<!-- ```{r importRGDAL, margin=TRUE, fig.height=5, fig.width=5} -->
<!-- library(rgdal) -->
<!-- # path to the ESRI Shapefile embedded in cartography -->
<!-- path_to_file <- system.file("shape/martinique.shp", package="cartography") -->
<!-- mtq <- readOGR(dsn = path_to_file, verbose = FALSE) -->
<!-- class(mtq) -->
<!-- ``` -->


<!-- ## The `sf` Way -->
<!-- ```{r importSF, margin=TRUE,fig.height=5, fig.width=5} -->
<!-- library(sf) -->
<!-- # path to the ESRI Shapefile embedded in cartography -->
<!-- path_to_file <- system.file("shape/martinique.shp", package="cartography") -->
<!-- mtq <- st_read(dsn = path_to_file, quiet = TRUE) -->
<!-- class(mtq) -->
<!-- ``` -->


<!-- # Europe Dataset  -->
<!-- ```{r importDataSet, margin=TRUE, fig.height=5, fig.width=7} -->
<!-- library(cartography) -->
<!-- # Load data -->
<!-- data(nuts2006) -->

<!-- # Plot a layer with the extent of the EU28 countries with only a background color -->
<!-- plot(nuts0.spdf, border = NA, col = NA, bg = "#A6CAE0") -->
<!-- # Plot non european space -->
<!-- plot(world.spdf, col  = "#E3DEBF", border=NA, add=TRUE) -->
<!-- # Plot a layer of countries borders -->
<!-- plot(nuts0.spdf, border = "grey20", lwd = 3, add = TRUE) -->
<!-- # Plot a layer of NUTS1 -->
<!-- plot(nuts1.spdf, border = "grey30", lwd = 2, add = TRUE) -->
<!-- # Plot a layer of NUTS2 -->
<!-- plot(nuts2.spdf, border = "grey40", lwd = 0.5, add = TRUE) -->
<!-- # Plot a layer of NUTS3 -->
<!-- plot(nuts3.spdf, border = "grey20", lwd = 0.1, add = TRUE) -->
<!-- ``` -->




## Label Map

```{r labelMap, fig.height=6, fig.width=5, margin=TRUE}
library(sf)
library(cartography)
# path to the ESRI Shapefile embedded in cartography
path_to_file <- system.file("shape/martinique.shp", package="cartography")
# import the Shapefile to a sf object
mtq <- st_read(dsn = path_to_file, quiet = TRUE)
# plot communes
plot(
  st_geometry(mtq), 
  col = "darkseagreen3", 
  border = "darkseagreen4", 
  bg = "lightblue1", 
  lwd = 0.5
)
# Label plot of the communes names
labelLayer(
  x = mtq, 
  txt = "LIBGEO", 
  col= "black", 
  cex = 0.7, 
  font = 4,
  halo = TRUE, 
  bg = "white", 
  r = 0.1, 
  overlap = FALSE, 
  show.lines = FALSE
)
# map layout
layoutLayer(
  title = "Communes of Martinique", 
  sources = "INSEE 2016",  
  author = paste0("cartography ", packageVersion("cartography")), 
  frame = FALSE,
  north = TRUE, 
  tabtitle = TRUE
) 


```

## Choropleth Map

```{r choroMap, fig.height=6, fig.width=5, margin=TRUE}
library(sf)
library(cartography)
# path to the ESRI Shapefile embedded in cartography
path_to_file <- system.file("shape/martinique.shp", package="cartography")
# import the Shapefile to a sf object
mtq <- st_read(dsn = path_to_file, quiet = TRUE)
# Compute the population density (inhab./km2) using sf::st_area()
mtq$POP_DENS <- 1000*1000 * mtq$P13_POP / st_area(mtq)

# Set a custom color palette
cols <- carto.pal(pal1 = "sand.pal", n1 = 5)
# plot communes (only the backgroung color is plotted)
plot(st_geometry(mtq), col = NA, border = NA, bg = "lightblue1")
# Plot the population density
choroLayer(
  x = mtq, 
  var = "POP_DENS",
  method = "geom",
  nclass=5,
  col = cols,
  border = "grey40", 
  lwd = 0.5,
  legend.pos = "topright", 
  legend.title.txt = "Population Density\n(people per km2)",
  add = TRUE
) 
# http://webhelp.esri.com/arcgisdesktop/9.2/index.cfm?topicname=geometrical_interval
layoutLayer(
  title = "Population Distribution in Martinique", 
  sources = "INSEE 2016",  
  author = paste0("cartography ", packageVersion("cartography")), 
  frame = FALSE,
  north = FALSE, 
  tabtitle = TRUE
) 

north(pos = "topleft")

```

## Base Map and Proportional Symbols

```{r propMap, fig.height=6, fig.width=5, message=FALSE, margin=TRUE, cache = TRUE}
## Plot OpenStreetMap tiles as basemap
# Download the tiles, nuts0.spdf extent
# mtq.osm <- getTiles(x = mtq, type = "osm", zoom = 11, crop = TRUE)
# # Plot the tiles
# tilesLayer(mtq.osm)
# plot communes (only borders are plotted)
plot(st_geometry(mtq), col = NA, border = "grey", add=FALSE)
# Plot communes population
propSymbolsLayer(
  x = mtq,
  var = "P13_POP",
  inches = 0.4,
  symbols = "circle",
  col = "brown4",
  legend.pos = "topright",
  legend.title.txt = "Total population"
)

layoutLayer(
  title = "Population Distribution in Martinique",
  sources = "INSEE 2016 - © OpenStreetMap contributors.\nTiles style under CC BY-SA, www.openstreetmap.org/copyright.",
  author = paste0("cartography ", packageVersion("cartography")),
  frame = FALSE,
  north = FALSE,
  tabtitle = TRUE
)

north(pos = "topleft")
```

## Isopleth Map

Unlike choropleth maps, which represent data as discrete values, isopleth maps are based on the assumption that the phenomenon to be represented has a continuous distribution. These maps use a spatial interaction modeling approach which aims to compute indicators based on stock values weighted by distance (Stewart 1942). It allows a spatial representation of the phenomenon independent from the initial heterogeneity of the territorial division. The result is easy to read and can be considered as a bypassing of the Modifiable Areal Unit Problem (MAUP) (Openshaw and Taylor 1979).

In cartography, the smoothLayer function, that heavily depends on the SpatialPosition (Giraud and Commenges 2016) package, allow to compute quickly these maps. The function takes as inputs a marked point layer and a set of parameters (a spatial interaction function and its parameters) and outputs an isopleth map layer (figure 6).

```{r isopleth, fig.height=6, fig.width=5, margin=TRUE}
library(sf)
library(cartography)
# path to the ESRI Shapefile embedded in cartography
path_to_file <- system.file("shape/martinique.shp", package="cartography")
# import the Shapefile to a sf object
mtq <- st_read(dsn = path_to_file, quiet = TRUE)
options(scipen = 6)
plot(st_geometry(mtq), col = NA, border = NA, bg = "lightblue1")
smoothLayer(
  x = mtq, 
  var = 'P13_POP',
  span = 4000, 
  beta = 2, 
  breaks = c(0,5000,seq(10000,100000,10000),105700 ),
  mask = mtq, 
  border = "grey",
  lwd = 0.2,
  col = carto.pal(pal1 = 'brown.pal', n1 = 12),
  legend.title.txt = "Population\nPotential",
  legend.pos = "topright", add=TRUE
)
text(
  x = 692582, y = 1611478, 
  labels = "Distance function:\n- type = exponential\n- beta = 2\n- span = 4 km", 
  cex = 0.8, adj = 0, font = 3
)
layoutLayer(
  title = "Population Distribution in Martinique",
  sources = "INSEE 2016",
  author = paste0("cartography ", packageVersion("cartography")),
  frame = FALSE,
  north = FALSE,
  tabtitle = TRUE
)

north(pos = "topleft")

```

